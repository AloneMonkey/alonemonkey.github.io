<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="description" content="猿，改变世界的动物！@AloneMonkey">
<meta name="keyword"  content="Coder,Android,iOS,安全,逆向,驱动,PHP">
<link rel="shortcut icon" href="/images/favicon.ico">


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






  <meta name="baidu-site-verification" content="8PIEzWgm2j" />







  
  
    
  
  <link href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






  

<link href="//cdn.bootcss.com/font-awesome/4.6.2/css/font-awesome.min.css" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="LLVM," />





  <link rel="alternate" href="/atom.xml" title="AloneMonkey" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="只要你和代码打交道，了解编译器的工作流程和原理定会让你受益无穷，无论是分析程序，还是基于它写自己的插件，甚至学习一门全新的语音。通过本文，将带你了解LLVM，并使用LLVM来完成一些有意思的事情。">
<meta property="og:type" content="article">
<meta property="og:title" content="关于LLVM，这些东西你必须知道！">
<meta property="og:url" content="http://www.alonemonkey.com/2016/12/21/learning-llvm/index.html">
<meta property="og:site_name" content="AloneMonkey">
<meta property="og:description" content="只要你和代码打交道，了解编译器的工作流程和原理定会让你受益无穷，无论是分析程序，还是基于它写自己的插件，甚至学习一门全新的语音。通过本文，将带你了解LLVM，并使用LLVM来完成一些有意思的事情。">
<meta property="og:image" content="http://7xtdl4.com1.z0.glb.clouddn.com/script_1482136450962.png">
<meta property="og:image" content="http://7xtdl4.com1.z0.glb.clouddn.com/script_1482136601642.png">
<meta property="og:image" content="http://7xtdl4.com1.z0.glb.clouddn.com/script_1482150626825.png">
<meta property="og:image" content="http://7xtdl4.com1.z0.glb.clouddn.com/script_1482218230417.png">
<meta property="og:image" content="http://7xtdl4.com1.z0.glb.clouddn.com/script_1482218636504.png">
<meta property="og:image" content="http://7xtdl4.com1.z0.glb.clouddn.com/script_1482219005958.png">
<meta property="og:image" content="http://7xtdl4.com1.z0.glb.clouddn.com/script_1482320827975.png">
<meta property="og:image" content="http://7xtdl4.com1.z0.glb.clouddn.com/script_1482318703701.png">
<meta property="og:image" content="http://7xtdl4.com1.z0.glb.clouddn.com/script_1482320959711.png">
<meta property="og:updated_time" content="2016-12-21T15:02:22.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="关于LLVM，这些东西你必须知道！">
<meta name="twitter:description" content="只要你和代码打交道，了解编译器的工作流程和原理定会让你受益无穷，无论是分析程序，还是基于它写自己的插件，甚至学习一门全新的语音。通过本文，将带你了解LLVM，并使用LLVM来完成一些有意思的事情。">
<meta name="twitter:image" content="http://7xtdl4.com1.z0.glb.clouddn.com/script_1482136450962.png">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>

  <title> 关于LLVM，这些东西你必须知道！ | AloneMonkey </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?58a7d0034fc8119156711597befcc3fe";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">AloneMonkey</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">Coder Blog</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-weekly">
          <a href="/weekly" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-rss-square"></i> <br />
            
            一周一报
          </a>
        </li>
      
        
        <li class="menu-item menu-item-classify">
          <a href="/classify" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-star"></i> <br />
            
            干货
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                关于LLVM，这些东西你必须知道！
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-12-21T00:00:00+08:00" content="2016-12-21">
              2016-12-21
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/llvm/" itemprop="url" rel="index">
                    <span itemprop="name">llvm</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/12/21/learning-llvm/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/21/learning-llvm/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>只要你和代码打交道，了解编译器的工作流程和原理定会让你受益无穷，无论是分析程序，还是基于它写自己的插件，甚至学习一门全新的语音。通过本文，将带你了解LLVM，并使用LLVM来完成一些有意思的事情。</p>
<h2 id="一、什么是LLVM？"><a href="#一、什么是LLVM？" class="headerlink" title="一、什么是LLVM？"></a>一、什么是LLVM？</h2><blockquote>
<p>The LLVM Project is a collection of modular and reusable compiler and toolchain technologies.</p>
</blockquote>
<p>简单来说，LLVM项目是一系列分模块、可重用的编译工具链。它提供了一种代码编写良好的中间表示(IR)，可以作为多种语言的后端，还可以提供与变成语言无关的优化和针对多种cpu的代码生成功能。</p>
<p>先来看下LLVM架构的主要组成部分：</p>
<ul>
<li>前端：前端用来获取源代码然后将它转变为某种中间表示，我们可以选择不同的编译器来作为LLVM的前端，如gcc，clang。</li>
<li>Pass(通常翻译为“流程”)：Pass用来将程序的中间表示之间相互变换。一般情况下，Pass可以用来优化代码，这部分通常是我们关注的部分。</li>
<li>后端：后端用来生成实际的机器码。</li>
</ul>
<p>虽然如今大多数编译器都采用的是这种架构，但是LLVM不同的就是对于不同的语言它都提供了同一种中间表示。传统的编译器的架构如下:</p>
<center><img src="http://7xtdl4.com1.z0.glb.clouddn.com/script_1482136450962.png"></center>

<p>LLVM的架构如下：</p>
<center><img src="http://7xtdl4.com1.z0.glb.clouddn.com/script_1482136601642.png"></center>

<p>当编译器需要支持多种源代码和目标架构时，基于LLVM的架构，设计一门新的语言只需要去实现一个新的前端就行了，支持新的后端架构也只需要实现一个新的后端就行了。其它部分完成可以复用，就不用再重新设计一次了。</p>
<h2 id="二、安装编译LLVM"><a href="#二、安装编译LLVM" class="headerlink" title="二、安装编译LLVM"></a>二、安装编译LLVM</h2><p>这里使用clang作为前端:</p>
<p>1.直接从官网下载:<a href="http://releases.llvm.org/download.html" target="_blank" rel="external">http://releases.llvm.org/download.html
</a></p>
<p>2.svn获取</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">svn co http://llvm.org/svn/llvm-project/llvm/trunk llvm</div><div class="line">cd llvm/tools</div><div class="line">svn co http://llvm.org/svn/llvm-project/cfe/trunk clang</div><div class="line">cd ../projects</div><div class="line">svn co http://llvm.org/svn/llvm-project/compiler-rt/trunk compiler-rt</div><div class="line">cd ../tools/clang/tools</div><div class="line">svn co http://llvm.org/svn/llvm-project/clang-tools-extra/trunk extra</div></pre></td></tr></table></figure>
<p>3.git获取</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">git clone http://llvm.org/git/llvm.git</div><div class="line">cd llvm/tools</div><div class="line">git clone http://llvm.org/git/clang.git</div><div class="line">cd ../projects</div><div class="line">git clone http://llvm.org/git/compiler-rt.git</div><div class="line">cd ../tools/clang/tools</div><div class="line">git clone http://llvm.org/git/clang-tools-extra.git</div></pre></td></tr></table></figure>
<p>最新的LLVM只支持cmake来编译了，首先安装cmake。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">brew install cmake</div></pre></td></tr></table></figure>
<p>编译：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mkdir build</div><div class="line">cmake /path/to/llvm/source</div><div class="line">cmake --build .</div></pre></td></tr></table></figure>
<p>编译时间比较长，而且编译结果会生成20G左右的文件。</p>
<p>编译完成后，就能在<code>build/bin/</code>目录下面找到生成的工具了。</p>
<h2 id="三、从源码到可执行文件"><a href="#三、从源码到可执行文件" class="headerlink" title="三、从源码到可执行文件"></a>三、从源码到可执行文件</h2><p>我们在开发的时候的时候，如果想要生成一个可执行文件或应用，我们点击run就完事了，那么在点击run之后编译器背后又做了哪些事情呢？</p>
<p>我们先来一个例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">#import &lt;Foundation/Foundation.h&gt;</div><div class="line"></div><div class="line">#define TEN 10</div><div class="line"></div><div class="line">int main()&#123;</div><div class="line">    @autoreleasepool &#123;</div><div class="line">        int numberOne = TEN;</div><div class="line">        int numberTwo = 8;</div><div class="line">        NSString* name = [[NSString alloc] initWithUTF8String:&quot;AloneMonkey&quot;];</div><div class="line">        int age = numberOne + numberTwo;</div><div class="line">        NSLog(@&quot;Hello, %@, Age: %d&quot;, name, age);</div><div class="line">    &#125;</div><div class="line">    return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面这个文件，我们可以通过命令行直接编译，然后链接：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">xcrun -sdk iphoneos clang -arch armv7 -F Foundation -fobjc-arc -c main.m -o main.o</div><div class="line">xcrun -sdk iphoneos clang main.o -arch armv7 -fobjc-arc -framework Foundation -o main</div></pre></td></tr></table></figure>
<p>拷贝到手机运行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">monkeyde-iPhone:/tmp root# ./main</div><div class="line">2016-12-19 17:16:34.654 main[2164:213100] Hello, AloneMonkey, Age: 18</div></pre></td></tr></table></figure>
<p>大家不会以为就这样就完了吧，当然不是，我们要继续深入剖析。</p>
<h3 id="3-1-预处理（Preprocess）"><a href="#3-1-预处理（Preprocess）" class="headerlink" title="3.1 预处理（Preprocess）"></a>3.1 预处理（Preprocess）</h3><p>这部分包括macro宏的展开，import/include头文件的导入，以及#if等处理。</p>
<p>可以通过执行以下命令，来告诉clang只执行到预处理这一步：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">clang -E main.m</div></pre></td></tr></table></figure>
<p>执行完这个命令之后，我们会发现导入了很多的头文件内容。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">......</div><div class="line"># 1 &quot;/System/Library/Frameworks/Foundation.framework/Headers/FoundationLegacySwiftCompatibility.h&quot; 1 3</div><div class="line"># 185 &quot;/System/Library/Frameworks/Foundation.framework/Headers/Foundation.h&quot; 2 3</div><div class="line"># 2 &quot;main.m&quot; 2</div><div class="line"></div><div class="line">int main()&#123;</div><div class="line">    @autoreleasepool &#123;</div><div class="line">        int numberOne = 10;</div><div class="line">        int numberTwo = 8;</div><div class="line">        NSString* name = [[NSString alloc] initWithUTF8String:&quot;AloneMonkey&quot;];</div><div class="line">        int age = numberOne + numberTwo;</div><div class="line">        NSLog(@&quot;Hello, %@, Age: %d&quot;, name, age);</div><div class="line">    &#125;</div><div class="line">    return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可以看到上面的预处理已经把宏替换了，并且导入了头文件。但是这样的话会引入很多不会去改变的系统库比如Foundation，所以有了pch预处理文件，可以在这里去引入一些通用的头文件。</p>
<p>后来Xcode新建的项目里面去掉了pch文件，引入了moduels的概念，把一些通用的库打成modules的形式，然后导入，默认会加上-fmodules参数。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">clang -E -fmodules main.m</div></pre></td></tr></table></figure>
<p>这样的话，只需要@import一下就能导入对应库的modules模块了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">@import Foundation; </div><div class="line">int main()&#123;</div><div class="line">    @autoreleasepool &#123;</div><div class="line">        int numberOne = 10;</div><div class="line">        int numberTwo = 8;</div><div class="line">        NSString* name = [[NSString alloc] initWithUTF8String:&quot;AloneMonkey&quot;];</div><div class="line">        int age = numberOne + numberTwo;</div><div class="line">        NSLog(@&quot;Hello, %@, Age: %d&quot;, name, age);</div><div class="line">    &#125;</div><div class="line">    return 0;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="3-2-词法分析-Lexical-Analysis"><a href="#3-2-词法分析-Lexical-Analysis" class="headerlink" title="3.2 词法分析 (Lexical Analysis)"></a>3.2 词法分析 (Lexical Analysis)</h3><p>在预处理之后，就要进行词法分析了，将预处理过的代码转化成一个个Token，比如左括号、右括号、等于、字符串等等。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">clang -fmodules -fsyntax-only -Xclang -dump-tokens main.m</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line">annot_module_include &apos;#import &lt;F&apos;		Loc=&lt;main.m:1:1&gt;</div><div class="line">int &apos;int&apos;	 [StartOfLine]	Loc=&lt;main.m:5:1&gt;</div><div class="line">identifier &apos;main&apos;	 [LeadingSpace]	Loc=&lt;main.m:5:5&gt;</div><div class="line">l_paren &apos;(&apos;		Loc=&lt;main.m:5:9&gt;</div><div class="line">r_paren &apos;)&apos;		Loc=&lt;main.m:5:10&gt;</div><div class="line">l_brace &apos;&#123;&apos;		Loc=&lt;main.m:5:11&gt;</div><div class="line">at &apos;@&apos;	 [StartOfLine] [LeadingSpace]	Loc=&lt;main.m:6:5&gt;</div><div class="line">identifier &apos;autoreleasepool&apos;		Loc=&lt;main.m:6:6&gt;</div><div class="line">l_brace &apos;&#123;&apos;	 [LeadingSpace]	Loc=&lt;main.m:6:22&gt;</div><div class="line">int &apos;int&apos;	 [StartOfLine] [LeadingSpace]	Loc=&lt;main.m:7:9&gt;</div><div class="line">identifier &apos;numberOne&apos;	 [LeadingSpace]	Loc=&lt;main.m:7:13&gt;</div><div class="line">equal &apos;=&apos;	 [LeadingSpace]	Loc=&lt;main.m:7:23&gt;</div><div class="line">numeric_constant &apos;10&apos;	 [LeadingSpace]	Loc=&lt;main.m:7:25 &lt;Spelling=main.m:3:13&gt;&gt;</div><div class="line">semi &apos;;&apos;		Loc=&lt;main.m:7:28&gt;</div><div class="line">int &apos;int&apos;	 [StartOfLine] [LeadingSpace]	Loc=&lt;main.m:8:9&gt;</div><div class="line">identifier &apos;numberTwo&apos;	 [LeadingSpace]	Loc=&lt;main.m:8:13&gt;</div><div class="line">equal &apos;=&apos;	 [LeadingSpace]	Loc=&lt;main.m:8:23&gt;</div><div class="line">numeric_constant &apos;8&apos;	 [LeadingSpace]	Loc=&lt;main.m:8:25&gt;</div><div class="line">semi &apos;;&apos;		Loc=&lt;main.m:8:26&gt;</div><div class="line">identifier &apos;NSString&apos;	 [StartOfLine] [LeadingSpace]	Loc=&lt;main.m:9:9&gt;</div><div class="line">star &apos;*&apos;		Loc=&lt;main.m:9:17&gt;</div><div class="line">identifier &apos;name&apos;	 [LeadingSpace]	Loc=&lt;main.m:9:19&gt;</div><div class="line">equal &apos;=&apos;	 [LeadingSpace]	Loc=&lt;main.m:9:24&gt;</div><div class="line">l_square &apos;[&apos;	 [LeadingSpace]	Loc=&lt;main.m:9:26&gt;</div><div class="line">l_square &apos;[&apos;		Loc=&lt;main.m:9:27&gt;</div><div class="line">identifier &apos;NSString&apos;		Loc=&lt;main.m:9:28&gt;</div><div class="line">identifier &apos;alloc&apos;	 [LeadingSpace]	Loc=&lt;main.m:9:37&gt;</div><div class="line">r_square &apos;]&apos;		Loc=&lt;main.m:9:42&gt;</div><div class="line">identifier &apos;initWithUTF8String&apos;	 [LeadingSpace]	Loc=&lt;main.m:9:44&gt;</div><div class="line">colon &apos;:&apos;		Loc=&lt;main.m:9:62&gt;</div><div class="line">string_literal &apos;&quot;AloneMonkey&quot;&apos;		Loc=&lt;main.m:9:63&gt;</div><div class="line">r_square &apos;]&apos;		Loc=&lt;main.m:9:76&gt;</div><div class="line">semi &apos;;&apos;		Loc=&lt;main.m:9:77&gt;</div><div class="line">int &apos;int&apos;	 [StartOfLine] [LeadingSpace]	Loc=&lt;main.m:10:9&gt;</div><div class="line">identifier &apos;age&apos;	 [LeadingSpace]	Loc=&lt;main.m:10:13&gt;</div><div class="line">equal &apos;=&apos;	 [LeadingSpace]	Loc=&lt;main.m:10:17&gt;</div><div class="line">identifier &apos;numberOne&apos;	 [LeadingSpace]	Loc=&lt;main.m:10:19&gt;</div><div class="line">plus &apos;+&apos;	 [LeadingSpace]	Loc=&lt;main.m:10:29&gt;</div><div class="line">identifier &apos;numberTwo&apos;	 [LeadingSpace]	Loc=&lt;main.m:10:31&gt;</div><div class="line">semi &apos;;&apos;		Loc=&lt;main.m:10:40&gt;</div><div class="line">identifier &apos;NSLog&apos;	 [StartOfLine] [LeadingSpace]	Loc=&lt;main.m:11:9&gt;</div><div class="line">l_paren &apos;(&apos;		Loc=&lt;main.m:11:14&gt;</div><div class="line">at &apos;@&apos;		Loc=&lt;main.m:11:15&gt;</div><div class="line">string_literal &apos;&quot;Hello, %@, Age: %d&quot;&apos;		Loc=&lt;main.m:11:16&gt;</div><div class="line">comma &apos;,&apos;		Loc=&lt;main.m:11:36&gt;</div><div class="line">identifier &apos;name&apos;	 [LeadingSpace]	Loc=&lt;main.m:11:38&gt;</div><div class="line">comma &apos;,&apos;		Loc=&lt;main.m:11:42&gt;</div><div class="line">identifier &apos;age&apos;	 [LeadingSpace]	Loc=&lt;main.m:11:44&gt;</div><div class="line">r_paren &apos;)&apos;		Loc=&lt;main.m:11:47&gt;</div><div class="line">semi &apos;;&apos;		Loc=&lt;main.m:11:48&gt;</div><div class="line">r_brace &apos;&#125;&apos;	 [StartOfLine] [LeadingSpace]	Loc=&lt;main.m:12:5&gt;</div><div class="line">return &apos;return&apos;	 [StartOfLine] [LeadingSpace]	Loc=&lt;main.m:13:5&gt;</div><div class="line">numeric_constant &apos;0&apos;	 [LeadingSpace]	Loc=&lt;main.m:13:12&gt;</div><div class="line">semi &apos;;&apos;		Loc=&lt;main.m:13:13&gt;</div><div class="line">r_brace &apos;&#125;&apos;	 [StartOfLine]	Loc=&lt;main.m:14:1&gt;</div><div class="line">eof &apos;&apos;		Loc=&lt;main.m:14:2&gt;</div></pre></td></tr></table></figure>
<h3 id="3-3-语法分析-Semantic-Analysis"><a href="#3-3-语法分析-Semantic-Analysis" class="headerlink" title="3.3 语法分析 (Semantic Analysis)"></a>3.3 语法分析 (Semantic Analysis)</h3><p>根据当前语言的语法，验证语法是否正确，并将所有节点组合成抽象语法树(AST)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">clang -fmodules -fsyntax-only -Xclang -ast-dump main.m</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">......</div><div class="line">`-FunctionDecl 0x7f8661d8a370 &lt;main.m:5:1, line:14:1&gt; line:5:5 main &apos;int ()&apos;</div><div class="line">  `-CompoundStmt 0x7f8661d8aab0 &lt;col:11, line:14:1&gt;</div><div class="line">    |-ObjCAutoreleasePoolStmt 0x7f8661d8aa68 &lt;line:6:5, line:12:5&gt;</div><div class="line">    | `-CompoundStmt 0x7f8661d8aa28 &lt;line:6:22, line:12:5&gt;</div><div class="line">    |   |-DeclStmt 0x7f8661d8a4a0 &lt;line:7:9, col:28&gt;</div><div class="line">    |   | `-VarDecl 0x7f8661d8a420 &lt;col:9, line:3:13&gt; line:7:13 used numberOne &apos;int&apos; cinit</div><div class="line">    |   |   `-IntegerLiteral 0x7f8661d8a480 &lt;line:3:13&gt; &apos;int&apos; 10</div><div class="line">    |   |-DeclStmt 0x7f8661d8a550 &lt;line:8:9, col:26&gt;</div><div class="line">    |   | `-VarDecl 0x7f8661d8a4d0 &lt;col:9, col:25&gt; col:13 used numberTwo &apos;int&apos; cinit</div><div class="line">    |   |   `-IntegerLiteral 0x7f8661d8a530 &lt;col:25&gt; &apos;int&apos; 8</div><div class="line">    |   |-DeclStmt 0x7f8661d8a6c0 &lt;line:9:9, col:77&gt;</div><div class="line">    |   | `-VarDecl 0x7f8661d8a580 &lt;col:9, col:76&gt; col:19 used name &apos;NSString *&apos; cinit</div><div class="line">    |   |   `-ObjCMessageExpr 0x7f8661d8a688 &lt;col:26, col:76&gt; &apos;NSString * _Nullable&apos;:&apos;NSString *&apos; selector=initWithUTF8String:</div><div class="line">    |   |     |-ObjCMessageExpr 0x7f8661d8a5f0 &lt;col:27, col:42&gt; &apos;NSString *&apos; selector=alloc class=&apos;NSString&apos;</div><div class="line">    |   |     `-ImplicitCastExpr 0x7f8661d8a670 &lt;col:63&gt; &apos;const char * _Nonnull&apos;:&apos;const char *&apos; &lt;BitCast&gt;</div><div class="line">    |   |       `-ImplicitCastExpr 0x7f8661d8a658 &lt;col:63&gt; &apos;char *&apos; &lt;ArrayToPointerDecay&gt;</div><div class="line">    |   |         `-StringLiteral 0x7f8661d8a620 &lt;col:63&gt; &apos;char [12]&apos; lvalue &quot;AloneMonkey&quot;</div><div class="line">    |   |-DeclStmt 0x7f8661d8a7f8 &lt;line:10:9, col:40&gt;</div><div class="line">    |   | `-VarDecl 0x7f8661d8a6f0 &lt;col:9, col:31&gt; col:13 used age &apos;int&apos; cinit</div><div class="line">    |   |   `-BinaryOperator 0x7f8661d8a7d0 &lt;col:19, col:31&gt; &apos;int&apos; &apos;+&apos;</div><div class="line">    |   |     |-ImplicitCastExpr 0x7f8661d8a7a0 &lt;col:19&gt; &apos;int&apos; &lt;LValueToRValue&gt;</div><div class="line">    |   |     | `-DeclRefExpr 0x7f8661d8a750 &lt;col:19&gt; &apos;int&apos; lvalue Var 0x7f8661d8a420 &apos;numberOne&apos; &apos;int&apos;</div><div class="line">    |   |     `-ImplicitCastExpr 0x7f8661d8a7b8 &lt;col:31&gt; &apos;int&apos; &lt;LValueToRValue&gt;</div><div class="line">    |   |       `-DeclRefExpr 0x7f8661d8a778 &lt;col:31&gt; &apos;int&apos; lvalue Var 0x7f8661d8a4d0 &apos;numberTwo&apos; &apos;int&apos;</div><div class="line">    |   `-CallExpr 0x7f8661d8a9a0 &lt;line:11:9, col:47&gt; &apos;void&apos;</div><div class="line">    |     |-ImplicitCastExpr 0x7f8661d8a988 &lt;col:9&gt; &apos;void (*)(id, ...)&apos; &lt;FunctionToPointerDecay&gt;</div><div class="line">    |     | `-DeclRefExpr 0x7f8661d8a810 &lt;col:9&gt; &apos;void (id, ...)&apos; Function 0x7f86618df0e0 &apos;NSLog&apos; &apos;void (id, ...)&apos;</div><div class="line">    |     |-ImplicitCastExpr 0x7f8661d8a9e0 &lt;col:15, col:16&gt; &apos;id&apos;:&apos;id&apos; &lt;BitCast&gt;</div><div class="line">    |     | `-ObjCStringLiteral 0x7f8661d8a8b8 &lt;col:15, col:16&gt; &apos;NSString *&apos;</div><div class="line">    |     |   `-StringLiteral 0x7f8661d8a878 &lt;col:16&gt; &apos;char [19]&apos; lvalue &quot;Hello, %@, Age: %d&quot;</div><div class="line">    |     |-ImplicitCastExpr 0x7f8661d8a9f8 &lt;col:38&gt; &apos;NSString *&apos; &lt;LValueToRValue&gt;</div><div class="line">    |     | `-DeclRefExpr 0x7f8661d8a8d8 &lt;col:38&gt; &apos;NSString *&apos; lvalue Var 0x7f8661d8a580 &apos;name&apos; &apos;NSString *&apos;</div><div class="line">    |     `-ImplicitCastExpr 0x7f8661d8aa10 &lt;col:44&gt; &apos;int&apos; &lt;LValueToRValue&gt;</div><div class="line">    |       `-DeclRefExpr 0x7f8661d8a900 &lt;col:44&gt; &apos;int&apos; lvalue Var 0x7f8661d8a6f0 &apos;age&apos; &apos;int&apos;</div><div class="line">    `-ReturnStmt 0x7f8661d8aa98 &lt;line:13:5, col:12&gt;</div><div class="line">      `-IntegerLiteral 0x7f8661d8aa78 &lt;col:12&gt; &apos;int&apos; 0</div></pre></td></tr></table></figure>
<p>语法树直观图:</p>
<p><img src="http://7xtdl4.com1.z0.glb.clouddn.com/script_1482150626825.png" alt="image"></p>
<h3 id="3-4-IR代码生成-CodeGen"><a href="#3-4-IR代码生成-CodeGen" class="headerlink" title="3.4 IR代码生成 (CodeGen)"></a>3.4 IR代码生成 (CodeGen)</h3><p>CodeGen负责将语法树从顶至下遍历，翻译成LLVM IR，LLVM IR是Frontend的输出，也是LLVM Backerend的输入，桥接前后端。</p>
<p>可以在中间代码层次去做一些优化工作，我们在Xcode的编译设置里面也可以设置优化级别<code>-O1</code>,<code>-O3</code>,<code>-Os</code>。 还可以去写一些自己的Pass，这里需要解释一下什么是Pass。</p>
<p>Pass就是LLVM系统转化和优化的工作的一个节点，每个节点做一些工作，这些工作加起来就构成了LLVM整个系统的优化和转化。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">clang -S -fobjc-arc -emit-llvm main.m -o main.ll</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line">......</div><div class="line">; Function Attrs: ssp uwtable</div><div class="line">define i32 @main() #0 &#123;</div><div class="line">entry:</div><div class="line">  %retval = alloca i32, align 4</div><div class="line">  %numberOne = alloca i32, align 4</div><div class="line">  %numberTwo = alloca i32, align 4</div><div class="line">  %name = alloca %0*, align 8</div><div class="line">  %age = alloca i32, align 4</div><div class="line">  store i32 0, i32* %retval, align 4</div><div class="line">  %0 = call i8* @objc_autoreleasePoolPush() #3</div><div class="line">  store i32 10, i32* %numberOne, align 4</div><div class="line">  store i32 8, i32* %numberTwo, align 4</div><div class="line">  %1 = load %struct._class_t*, %struct._class_t** @&quot;OBJC_CLASSLIST_REFERENCES_$_&quot;, align 8</div><div class="line">  %2 = load i8*, i8** @OBJC_SELECTOR_REFERENCES_, align 8, !invariant.load !7</div><div class="line">  %3 = bitcast %struct._class_t* %1 to i8*</div><div class="line">  %call = call i8* bitcast (i8* (i8*, i8*, ...)* @objc_msgSend to i8* (i8*, i8*)*)(i8* %3, i8* %2)</div><div class="line">  %4 = bitcast i8* %call to %0*</div><div class="line">  %5 = load i8*, i8** @OBJC_SELECTOR_REFERENCES_.2, align 8, !invariant.load !7</div><div class="line">  %6 = bitcast %0* %4 to i8*</div><div class="line">  %call1 = call i8* bitcast (i8* (i8*, i8*, ...)* @objc_msgSend to i8* (i8*, i8*, i8*)*)(i8* %6, i8* %5, i8* getelementptr inbounds ([12 x i8], [12 x i8]* @.str, i32 0, i32 0))</div><div class="line">  %7 = bitcast i8* %call1 to %0*</div><div class="line">  store %0* %7, %0** %name, align 8</div><div class="line">  %8 = load i32, i32* %numberOne, align 4</div><div class="line">  %9 = load i32, i32* %numberTwo, align 4</div><div class="line">  %10 = sub i32 0, %9</div><div class="line">  %11 = sub nsw i32 %8, %10</div><div class="line">  %add = add nsw i32 %8, %9</div><div class="line">  store i32 %11, i32* %age, align 4</div><div class="line">  %12 = load %0*, %0** %name, align 8</div><div class="line">  %13 = load i32, i32* %age, align 4</div><div class="line">  notail call void (i8*, ...) @NSLog(i8* bitcast (%struct.__NSConstantString_tag* @_unnamed_cfstring_ to i8*), %0* %12, i32 %13)</div><div class="line">  %14 = bitcast %0** %name to i8**</div><div class="line">  call void @objc_storeStrong(i8** %14, i8* null) #3</div><div class="line">  call void @objc_autoreleasePoolPop(i8* %0)</div><div class="line">  ret i32 0</div><div class="line">&#125;</div><div class="line"></div><div class="line">declare i8* @objc_autoreleasePoolPush()</div><div class="line"></div><div class="line">; Function Attrs: nonlazybind</div><div class="line">declare i8* @objc_msgSend(i8*, i8*, ...) #1</div><div class="line"></div><div class="line">declare void @NSLog(i8*, ...) #2</div><div class="line"></div><div class="line">declare void @objc_storeStrong(i8**, i8*)</div><div class="line"></div><div class="line">declare void @objc_autoreleasePoolPop(i8*)</div><div class="line"></div><div class="line">......</div><div class="line">!6 = !&#123;!&quot;clang version 4.0.0 (trunk 289913) (llvm/trunk 289911)&quot;&#125;</div><div class="line">!7 = !&#123;&#125;</div></pre></td></tr></table></figure>
<h3 id="3-5-生成字节码-LLVM-Bitcode"><a href="#3-5-生成字节码-LLVM-Bitcode" class="headerlink" title="3.5 生成字节码 (LLVM Bitcode)"></a>3.5 生成字节码 (LLVM Bitcode)</h3><p>我们在Xcode7中默认生成bitcode就是这种的中间形式存在， 开启了bitcode，那么苹果后台拿到的就是这种中间代码，苹果可以对bitcode做一个进一步的优化，如果有新的后端架构，仍然可以用这份bitcode去生成。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">clang -emit-llvm -c main.m -o main.bc</div></pre></td></tr></table></figure>
<p><img src="http://7xtdl4.com1.z0.glb.clouddn.com/script_1482218230417.png" alt="image"></p>
<h3 id="3-6-生成相关汇编"><a href="#3-6-生成相关汇编" class="headerlink" title="3.6 生成相关汇编"></a>3.6 生成相关汇编</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">clang -S -fobjc-arc main.m -o main.s</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div></pre></td><td class="code"><pre><div class="line">	.section	__TEXT,__text,regular,pure_instructions</div><div class="line">	.macosx_version_min 10, 12</div><div class="line">	.globl	_main</div><div class="line">	.p2align	4, 0x90</div><div class="line">_main:                                  ## @main</div><div class="line">	.cfi_startproc</div><div class="line">## BB#0:                                ## %entry</div><div class="line">	pushq	%rbp</div><div class="line">Lcfi0:</div><div class="line">	.cfi_def_cfa_offset 16</div><div class="line">Lcfi1:</div><div class="line">	.cfi_offset %rbp, -16</div><div class="line">	movq	%rsp, %rbp</div><div class="line">Lcfi2:</div><div class="line">	.cfi_def_cfa_register %rbp</div><div class="line">	subq	$48, %rsp</div><div class="line">	movl	$0, -4(%rbp)</div><div class="line">	callq	_objc_autoreleasePoolPush</div><div class="line">	movl	$10, -8(%rbp)</div><div class="line">	movl	$8, -12(%rbp)</div><div class="line">	movq	L_OBJC_CLASSLIST_REFERENCES_$_(%rip), %rcx</div><div class="line">	movq	L_OBJC_SELECTOR_REFERENCES_(%rip), %rsi</div><div class="line">	movq	%rcx, %rdi</div><div class="line">	movq	%rax, -40(%rbp)         ## 8-byte Spill</div><div class="line">	callq	_objc_msgSend</div><div class="line">	leaq	L_.str(%rip), %rdx</div><div class="line">	movq	L_OBJC_SELECTOR_REFERENCES_.2(%rip), %rsi</div><div class="line">	movq	%rax, %rdi</div><div class="line">	callq	_objc_msgSend</div><div class="line">	leaq	L__unnamed_cfstring_(%rip), %rcx</div><div class="line">	xorl	%r8d, %r8d</div><div class="line">	movq	%rax, -24(%rbp)</div><div class="line">	movl	-8(%rbp), %r9d</div><div class="line">	movl	-12(%rbp), %r10d</div><div class="line">	subl	%r10d, %r8d</div><div class="line">	subl	%r8d, %r9d</div><div class="line">	movl	%r9d, -28(%rbp)</div><div class="line">	movq	-24(%rbp), %rsi</div><div class="line">	movl	-28(%rbp), %edx</div><div class="line">	movq	%rcx, %rdi</div><div class="line">	movb	$0, %al</div><div class="line">	callq	_NSLog</div><div class="line">	xorl	%edx, %edx</div><div class="line">	movl	%edx, %esi</div><div class="line">	leaq	-24(%rbp), %rcx</div><div class="line">	movq	%rcx, %rdi</div><div class="line">	callq	_objc_storeStrong</div><div class="line">	movq	-40(%rbp), %rdi         ## 8-byte Reload</div><div class="line">	callq	_objc_autoreleasePoolPop</div><div class="line">	xorl	%eax, %eax</div><div class="line">	addq	$48, %rsp</div><div class="line">	popq	%rbp</div><div class="line">	retq</div><div class="line">	.cfi_endproc</div><div class="line"></div><div class="line">	.section	__DATA,__objc_classrefs,regular,no_dead_strip</div><div class="line">	.p2align	3               ## @&quot;OBJC_CLASSLIST_REFERENCES_$_&quot;</div><div class="line">L_OBJC_CLASSLIST_REFERENCES_$_:</div><div class="line">	.quad	_OBJC_CLASS_$_NSString</div><div class="line"></div><div class="line">	.section	__TEXT,__objc_methname,cstring_literals</div><div class="line">L_OBJC_METH_VAR_NAME_:                  ## @OBJC_METH_VAR_NAME_</div><div class="line">	.asciz	&quot;alloc&quot;</div><div class="line"></div><div class="line">	.section	__DATA,__objc_selrefs,literal_pointers,no_dead_strip</div><div class="line">	.p2align	3               ## @OBJC_SELECTOR_REFERENCES_</div><div class="line">L_OBJC_SELECTOR_REFERENCES_:</div><div class="line">	.quad	L_OBJC_METH_VAR_NAME_</div><div class="line"></div><div class="line">	.section	__TEXT,__cstring,cstring_literals</div><div class="line">L_.str:                                 ## @.str</div><div class="line">	.asciz	&quot;AloneMonkey&quot;</div><div class="line"></div><div class="line">	.section	__TEXT,__objc_methname,cstring_literals</div><div class="line">L_OBJC_METH_VAR_NAME_.1:                ## @OBJC_METH_VAR_NAME_.1</div><div class="line">	.asciz	&quot;initWithUTF8String:&quot;</div><div class="line"></div><div class="line">	.section	__DATA,__objc_selrefs,literal_pointers,no_dead_strip</div><div class="line">	.p2align	3               ## @OBJC_SELECTOR_REFERENCES_.2</div><div class="line">L_OBJC_SELECTOR_REFERENCES_.2:</div><div class="line">	.quad	L_OBJC_METH_VAR_NAME_.1</div><div class="line"></div><div class="line">	.section	__TEXT,__cstring,cstring_literals</div><div class="line">L_.str.3:                               ## @.str.3</div><div class="line">	.asciz	&quot;Hello, %@, Age: %d&quot;</div><div class="line"></div><div class="line">	.section	__DATA,__cfstring</div><div class="line">	.p2align	3               ## @_unnamed_cfstring_</div><div class="line">L__unnamed_cfstring_:</div><div class="line">	.quad	___CFConstantStringClassReference</div><div class="line">	.long	1992                    ## 0x7c8</div><div class="line">	.space	4</div><div class="line">	.quad	L_.str.3</div><div class="line">	.quad	18                      ## 0x12</div><div class="line"></div><div class="line">	.section	__DATA,__objc_imageinfo,regular,no_dead_strip</div><div class="line">L_OBJC_IMAGE_INFO:</div><div class="line">	.long	0</div><div class="line">	.long	64</div><div class="line"></div><div class="line"></div><div class="line">.subsections_via_symbols</div></pre></td></tr></table></figure>
<h3 id="3-7-生成目标文件"><a href="#3-7-生成目标文件" class="headerlink" title="3.7 生成目标文件"></a>3.7 生成目标文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">clang -fmodules -c main.m -o main.o</div></pre></td></tr></table></figure>
<p><img src="http://7xtdl4.com1.z0.glb.clouddn.com/script_1482218636504.png" alt="image"></p>
<h3 id="3-8-生成可执行文件"><a href="#3-8-生成可执行文件" class="headerlink" title="3.8 生成可执行文件"></a>3.8 生成可执行文件</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">clang main.o -o main</div><div class="line">./main</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">2016-12-20 15:25:42.299 main[8941:327306] Hello, AloneMonkey, Age: 18</div></pre></td></tr></table></figure>
<h3 id="3-9-整体流程"><a href="#3-9-整体流程" class="headerlink" title="3.9 整体流程"></a>3.9 整体流程</h3><p><img src="http://7xtdl4.com1.z0.glb.clouddn.com/script_1482219005958.png" alt="image"></p>
<h2 id="四、可以用Clang做什么？"><a href="#四、可以用Clang做什么？" class="headerlink" title="四、可以用Clang做什么？"></a>四、可以用Clang做什么？</h2><h3 id="4-1-libclang进行语法分析"><a href="#4-1-libclang进行语法分析" class="headerlink" title="4.1 libclang进行语法分析"></a>4.1 libclang进行语法分析</h3><p>可以使用libclang里面提供的方法对源文件进行语法分析，分析它的语法树，遍历语法树上面的每一个节点。可以用于检查拼写错误，或者做字符串加密。</p>
<p>来看一段代码的使用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">void *hand = dlopen(&quot;/Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/libclang.dylib&quot;,RTLD_LAZY);</div><div class="line">        </div><div class="line">//初始化函数指针</div><div class="line">initlibfunclist(hand);</div><div class="line"></div><div class="line">CXIndex cxindex = myclang_createIndex(1, 1);</div><div class="line"></div><div class="line">const char *filename = &quot;/path/to/filename&quot;;</div><div class="line"></div><div class="line">int index = 0;</div><div class="line"></div><div class="line">const char ** new_command = malloc(10240);</div><div class="line"></div><div class="line">NSMutableString *mus = [NSMutableString stringWithString:@&quot;/Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/bin/clang -x objective-c -arch armv7 -isysroot /Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/SDKs/iPhoneOS.sdk&quot;]; </div><div class="line"></div><div class="line">NSArray *arr = [mus componentsSeparatedByString:@&quot; &quot;];</div><div class="line"></div><div class="line">for (NSString *tmp in arr) &#123;</div><div class="line">    new_command[index++] = [tmp UTF8String];</div><div class="line">&#125;</div><div class="line"></div><div class="line">nameArr = [[NSMutableArray alloc] initWithCapacity:10];</div><div class="line"></div><div class="line">TU = myclang_parseTranslationUnit(cxindex, filename, new_command, index, NULL, 0, myclang_defaultEditingTranslationUnitOptions());</div><div class="line"></div><div class="line">CXCursor rootCursor = myclang_getTranslationUnitCursor(TU);</div><div class="line"></div><div class="line">myclang_visitChildren(rootCursor, printVisitor, NULL);</div><div class="line"></div><div class="line">myclang_disposeTranslationUnit(TU);</div><div class="line">myclang_disposeIndex(cxindex);</div><div class="line">free(new_command);</div><div class="line"></div><div class="line">dlclose(hand);</div></pre></td></tr></table></figure>
<p>然后我们就可以在<code>printVisitor</code>这个函数里面去遍历输入文件的语法树了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div></pre></td><td class="code"><pre><div class="line">2016-12-20 16:25:44.006588 ParseClangLib[9525:368452] showString</div><div class="line"> int main()&#123;</div><div class="line">    @autoreleasepool &#123;</div><div class="line">        int numberOne = TEN;</div><div class="line">        int numberTwo = 8;</div><div class="line">        NSString* name = [[NSString alloc] initWithUTF8String:&quot;AloneMonkey&quot;];</div><div class="line">        int age = numberOne + numberTwo;</div><div class="line">        NSLog(@&quot;Hello, %@, Age: %d&quot;, name, age);</div><div class="line">    &#125;</div><div class="line">    return 0;</div><div class="line">&#125;</div><div class="line">2016-12-20 16:25:44.007101 ParseClangLib[9525:368452] disname is main()</div><div class="line">2016-12-20 16:25:44.007142 ParseClangLib[9525:368452] ccurkind is =&gt;FunctionDecl</div><div class="line">2016-12-20 16:25:44.007180 ParseClangLib[9525:368452] 继续遍历孩子节点main()</div><div class="line">2016-12-20 16:25:44.007236 ParseClangLib[9525:368452] showString</div><div class="line"> &#123;</div><div class="line">    @autoreleasepool &#123;</div><div class="line">        int numberOne = TEN;</div><div class="line">        int numberTwo = 8;</div><div class="line">        NSString* name = [[NSString alloc] initWithUTF8String:&quot;AloneMonkey&quot;];</div><div class="line">        int age = numberOne + numberTwo;</div><div class="line">        NSLog(@&quot;Hello, %@, Age: %d&quot;, name, age);</div><div class="line">    &#125;</div><div class="line">    return 0;</div><div class="line">&#125;</div><div class="line">2016-12-20 16:25:44.007253 ParseClangLib[9525:368452] disname is</div><div class="line">2016-12-20 16:25:44.007263 ParseClangLib[9525:368452] ccurkind is =&gt;CompoundStmt</div><div class="line">2016-12-20 16:25:44.007274 ParseClangLib[9525:368452] 继续遍历孩子节点</div><div class="line">2016-12-20 16:25:44.007309 ParseClangLib[9525:368452] showString</div><div class="line"> @autoreleasepool &#123;</div><div class="line">        int numberOne = TEN;</div><div class="line">        int numberTwo = 8;</div><div class="line">        NSString* name = [[NSString alloc] initWithUTF8String:&quot;AloneMonkey&quot;];</div><div class="line">        int age = numberOne + numberTwo;</div><div class="line">        NSLog(@&quot;Hello, %@, Age: %d&quot;, name, age);</div><div class="line">    &#125;</div><div class="line">2016-12-20 16:25:44.007424 ParseClangLib[9525:368452] disname is</div><div class="line">2016-12-20 16:25:44.007442 ParseClangLib[9525:368452] ccurkind is =&gt;ObjCAutoreleasePoolStmt</div><div class="line">2016-12-20 16:25:44.007455 ParseClangLib[9525:368452] 继续遍历孩子节点</div><div class="line">2016-12-20 16:25:44.007488 ParseClangLib[9525:368452] showString</div><div class="line"> &#123;</div><div class="line">        int numberOne = TEN;</div><div class="line">        int numberTwo = 8;</div><div class="line">        NSString* name = [[NSString alloc] initWithUTF8String:&quot;AloneMonkey&quot;];</div><div class="line">        int age = numberOne + numberTwo;</div><div class="line">        NSLog(@&quot;Hello, %@, Age: %d&quot;, name, age);</div><div class="line">    &#125;</div><div class="line">2016-12-20 16:25:44.007504 ParseClangLib[9525:368452] disname is</div><div class="line">2016-12-20 16:25:44.007514 ParseClangLib[9525:368452] ccurkind is =&gt;CompoundStmt</div><div class="line">2016-12-20 16:25:44.007525 ParseClangLib[9525:368452] 继续遍历孩子节点</div><div class="line">2016-12-20 16:25:44.007553 ParseClangLib[9525:368452] showString</div><div class="line"> int numberOne = TEN;</div><div class="line">2016-12-20 16:25:44.007565 ParseClangLib[9525:368452] disname is</div><div class="line">2016-12-20 16:25:44.007574 ParseClangLib[9525:368452] ccurkind is =&gt;DeclStmt</div><div class="line">2016-12-20 16:25:44.013133 ParseClangLib[9525:368452] 继续遍历孩子节点</div><div class="line">2016-12-20 16:25:44.013206 ParseClangLib[9525:368452] showString</div><div class="line"> int numberOne = TEN</div><div class="line">.......</div><div class="line">2016-12-20 16:25:44.015848 ParseClangLib[9525:368452] ccurkind is =&gt;ObjCStringLiteral</div><div class="line">2016-12-20 16:25:44.015858 ParseClangLib[9525:368452] OC 字符串</div><div class="line">2016-12-20 16:25:44.015876 ParseClangLib[9525:368452] showString</div><div class="line"> @&quot;Hello, %@, Age: %d&quot;</div><div class="line">2016-12-20 16:25:44.015932 ParseClangLib[9525:368452] showString</div><div class="line"> name</div><div class="line">2016-12-20 16:25:44.015973 ParseClangLib[9525:368452] disname is name</div><div class="line">2016-12-20 16:25:44.015997 ParseClangLib[9525:368452] ccurkind is =&gt;UnexposedExpr</div><div class="line">2016-12-20 16:25:44.016013 ParseClangLib[9525:368452] 继续遍历孩子节点name</div><div class="line">2016-12-20 16:25:44.016039 ParseClangLib[9525:368452] showString</div><div class="line"> name</div><div class="line">2016-12-20 16:25:44.016051 ParseClangLib[9525:368452] disname is name</div><div class="line">2016-12-20 16:25:44.016060 ParseClangLib[9525:368452] ccurkind is =&gt;DeclRefExpr</div><div class="line">2016-12-20 16:25:44.016071 ParseClangLib[9525:368452] 继续遍历孩子节点</div><div class="line">2016-12-20 16:25:44.016137 ParseClangLib[9525:368452] showString</div><div class="line"> age</div><div class="line">2016-12-20 16:25:44.016160 ParseClangLib[9525:368452] disname is age</div><div class="line">2016-12-20 16:25:44.016170 ParseClangLib[9525:368452] ccurkind is =&gt;UnexposedExpr</div><div class="line">2016-12-20 16:25:44.016183 ParseClangLib[9525:368452] 继续遍历孩子节点</div><div class="line">2016-12-20 16:25:44.016213 ParseClangLib[9525:368452] showString</div><div class="line"> age</div><div class="line">2016-12-20 16:25:44.016256 ParseClangLib[9525:368452] disname is age</div><div class="line">2016-12-20 16:25:44.016279 ParseClangLib[9525:368452] ccurkind is =&gt;DeclRefExpr</div><div class="line">2016-12-20 16:25:44.016293 ParseClangLib[9525:368452] 继续遍历孩子节点age</div><div class="line">2016-12-20 16:25:44.016318 ParseClangLib[9525:368452] showString</div><div class="line"> return 0</div><div class="line">2016-12-20 16:25:44.016330 ParseClangLib[9525:368452] disname is</div><div class="line">2016-12-20 16:25:44.016339 ParseClangLib[9525:368452] ccurkind is =&gt;ReturnStmt</div><div class="line">2016-12-20 16:25:44.016350 ParseClangLib[9525:368452] 继续遍历孩子节点</div><div class="line">2016-12-20 16:25:44.016369 ParseClangLib[9525:368452] showString</div><div class="line"> 0</div><div class="line">2016-12-20 16:25:44.016408 ParseClangLib[9525:368452] disname is</div><div class="line">2016-12-20 16:25:44.016445 ParseClangLib[9525:368452] ccurkind is =&gt;IntegerLiteral</div><div class="line">2016-12-20 16:25:44.016461 ParseClangLib[9525:368452] 继续遍历孩子节点</div></pre></td></tr></table></figure>
<p>我们也通过通过python去调用用clang：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pip install clang</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">#!/usr/bin/python</div><div class="line"># vim: set fileencoding=utf-8</div><div class="line"></div><div class="line">import clang.cindex</div><div class="line">import asciitree</div><div class="line">import sys</div><div class="line"></div><div class="line">def node_children(node):</div><div class="line">	return (c for c in node.get_children() if c.location.file == sys.argv[1])</div><div class="line"></div><div class="line">def print_node(node):</div><div class="line">    text = node.spelling or node.displayname</div><div class="line">    kind = str(node.kind)[str(node.kind).index(&apos;.&apos;)+1:]</div><div class="line">    return &apos;&#123;&#125; &#123;&#125;&apos;.format(kind, text)</div><div class="line"></div><div class="line">if len(sys.argv) != 2:</div><div class="line">    print(&quot;Usage: dump_ast.py [header file name]&quot;)</div><div class="line">    sys.exit()</div><div class="line"></div><div class="line">clang.cindex.Config.set_library_file(&apos;/Applications/Xcode.app/Contents/Developer/Toolchains/XcodeDefault.xctoolchain/usr/lib/libclang.dylib&apos;)</div><div class="line">index = clang.cindex.Index.create()</div><div class="line">translation_unit = index.parse(sys.argv[1], [&apos;-x&apos;, &apos;objective-c&apos;])</div><div class="line"></div><div class="line">print asciitree.draw_tree(translation_unit.cursor,</div><div class="line">                          lambda n: list(n.get_children()),</div><div class="line">                          lambda n: &quot;%s (%s)&quot; % (n.spelling or n.displayname, str(n.kind).split(&quot;.&quot;)[1]))</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">.......</div><div class="line">  +--main (FUNCTION_DECL)</div><div class="line">     +-- (COMPOUND_STMT)</div><div class="line">        +-- (OBJC_AUTORELEASE_POOL_STMT)</div><div class="line">        |  +-- (COMPOUND_STMT)</div><div class="line">        |     +-- (DECL_STMT)</div><div class="line">        |     |  +--numberOne (VAR_DECL)</div><div class="line">        |     |     +-- (INTEGER_LITERAL)</div><div class="line">        |     +-- (DECL_STMT)</div><div class="line">        |     |  +--numberTwo (VAR_DECL)</div><div class="line">        |     |     +-- (INTEGER_LITERAL)</div><div class="line">        |     +-- (DECL_STMT)</div><div class="line">        |     |  +--name (VAR_DECL)</div><div class="line">        |     |     +--NSString (OBJC_CLASS_REF)</div><div class="line">        |     |     +--initWithUTF8String: (OBJC_MESSAGE_EXPR)</div><div class="line">        |     |        +--alloc (OBJC_MESSAGE_EXPR)</div><div class="line">        |     |        |  +--NSString (OBJC_CLASS_REF)</div><div class="line">        |     |        +-- (UNEXPOSED_EXPR)</div><div class="line">        |     |           +-- (UNEXPOSED_EXPR)</div><div class="line">        |     |              +--&quot;AloneMonkey&quot; (STRING_LITERAL)</div><div class="line">        |     +-- (DECL_STMT)</div><div class="line">        |     |  +--age (VAR_DECL)</div><div class="line">        |     |     +-- (BINARY_OPERATOR)</div><div class="line">        |     |        +--numberOne (UNEXPOSED_EXPR)</div><div class="line">        |     |        |  +--numberOne (DECL_REF_EXPR)</div><div class="line">        |     |        +--numberTwo (UNEXPOSED_EXPR)</div><div class="line">        |     |           +--numberTwo (DECL_REF_EXPR)</div><div class="line">        |     +--NSLog (CALL_EXPR)</div><div class="line">        |        +--NSLog (UNEXPOSED_EXPR)</div><div class="line">        |        |  +--NSLog (DECL_REF_EXPR)</div><div class="line">        |        +-- (UNEXPOSED_EXPR)</div><div class="line">        |        |  +--&quot;Hello, %@, Age: %d&quot; (OBJC_STRING_LITERAL)</div><div class="line">        |        |     +--&quot;Hello, %@, Age: %d&quot; (STRING_LITERAL)</div><div class="line">        |        +--name (UNEXPOSED_EXPR)</div><div class="line">        |        |  +--name (DECL_REF_EXPR)</div><div class="line">        |        +--age (UNEXPOSED_EXPR)</div><div class="line">        |           +--age (DECL_REF_EXPR)</div><div class="line">        +-- (RETURN_STMT)</div><div class="line">           +-- (INTEGER_LITERAL)</div></pre></td></tr></table></figure>
<p>那么基于语法树的分析，我们可以针对字符串做加密：</p>
<center><img src="http://7xtdl4.com1.z0.glb.clouddn.com/script_1482320827975.png"></center>

<p>从左上角的明文字符串，处理成右下角的介个样子~</p>
<h3 id="4-2-LibTooling"><a href="#4-2-LibTooling" class="headerlink" title="4.2 LibTooling"></a>4.2 LibTooling</h3><p>对语法树有完全的控制权，可以作为一个单独的命令使用，如：<code>clang-format</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">clang-format main.m</div></pre></td></tr></table></figure>
<p>我们也可以自己写一个这样的工具去遍历、访问、甚至修改语法树。 目录:<code>llvm/tools/clang/tools</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div></pre></td><td class="code"><pre><div class="line">#include &quot;clang/Driver/Options.h&quot;</div><div class="line">#include &quot;clang/AST/AST.h&quot;</div><div class="line">#include &quot;clang/AST/ASTContext.h&quot;</div><div class="line">#include &quot;clang/AST/ASTConsumer.h&quot;</div><div class="line">#include &quot;clang/AST/RecursiveASTVisitor.h&quot;</div><div class="line">#include &quot;clang/Frontend/ASTConsumers.h&quot;</div><div class="line">#include &quot;clang/Frontend/FrontendActions.h&quot;</div><div class="line">#include &quot;clang/Frontend/CompilerInstance.h&quot;</div><div class="line">#include &quot;clang/Tooling/CommonOptionsParser.h&quot;</div><div class="line">#include &quot;clang/Tooling/Tooling.h&quot;</div><div class="line">#include &quot;clang/Rewrite/Core/Rewriter.h&quot;</div><div class="line"></div><div class="line">using namespace std;</div><div class="line">using namespace clang;</div><div class="line">using namespace clang::driver;</div><div class="line">using namespace clang::tooling;</div><div class="line">using namespace llvm;</div><div class="line"></div><div class="line">Rewriter rewriter;</div><div class="line">int numFunctions = 0;</div><div class="line"></div><div class="line">static llvm::cl::OptionCategory StatSampleCategory(&quot;Stat Sample&quot;);</div><div class="line"></div><div class="line">class ExampleVisitor : public RecursiveASTVisitor&lt;ExampleVisitor&gt; &#123;</div><div class="line">private:</div><div class="line">    ASTContext *astContext; // used for getting additional AST info</div><div class="line"></div><div class="line">public:</div><div class="line">    explicit ExampleVisitor(CompilerInstance *CI) </div><div class="line">      : astContext(&amp;(CI-&gt;getASTContext())) // initialize private members</div><div class="line">    &#123;</div><div class="line">        rewriter.setSourceMgr(astContext-&gt;getSourceManager(), astContext-&gt;getLangOpts());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    virtual bool VisitFunctionDecl(FunctionDecl *func) &#123;</div><div class="line">        numFunctions++;</div><div class="line">        string funcName = func-&gt;getNameInfo().getName().getAsString();</div><div class="line">        if (funcName == &quot;do_math&quot;) &#123;</div><div class="line">            rewriter.ReplaceText(func-&gt;getLocation(), funcName.length(), &quot;add5&quot;);</div><div class="line">            errs() &lt;&lt; &quot;** Rewrote function def: &quot; &lt;&lt; funcName &lt;&lt; &quot;\n&quot;;</div><div class="line">        &#125;    </div><div class="line">        return true;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    virtual bool VisitStmt(Stmt *st) &#123;</div><div class="line">        if (ReturnStmt *ret = dyn_cast&lt;ReturnStmt&gt;(st)) &#123;</div><div class="line">            rewriter.ReplaceText(ret-&gt;getRetValue()-&gt;getLocStart(), 6, &quot;val&quot;);</div><div class="line">            errs() &lt;&lt; &quot;** Rewrote ReturnStmt\n&quot;;</div><div class="line">        &#125;        </div><div class="line">        if (CallExpr *call = dyn_cast&lt;CallExpr&gt;(st)) &#123;</div><div class="line">            rewriter.ReplaceText(call-&gt;getLocStart(), 7, &quot;add5&quot;);</div><div class="line">            errs() &lt;&lt; &quot;** Rewrote function call\n&quot;;</div><div class="line">        &#125;</div><div class="line">        return true;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">class ExampleASTConsumer : public ASTConsumer &#123;</div><div class="line">private:</div><div class="line">    ExampleVisitor *visitor; // doesn&apos;t have to be private</div><div class="line"></div><div class="line">public:</div><div class="line">    // override the constructor in order to pass CI</div><div class="line">    explicit ExampleASTConsumer(CompilerInstance *CI)</div><div class="line">        : visitor(new ExampleVisitor(CI)) // initialize the visitor</div><div class="line">    &#123; &#125;</div><div class="line"></div><div class="line">    // override this to call our ExampleVisitor on the entire source file</div><div class="line">    virtual void HandleTranslationUnit(ASTContext &amp;Context) &#123;</div><div class="line">        visitor-&gt;TraverseDecl(Context.getTranslationUnitDecl());</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">class ExampleFrontendAction : public ASTFrontendAction &#123;</div><div class="line">public:</div><div class="line">    virtual std::unique_ptr&lt;ASTConsumer&gt; CreateASTConsumer(CompilerInstance &amp;CI, StringRef file) &#123;</div><div class="line">         return llvm::make_unique&lt;ExampleASTConsumer&gt;(&amp;CI); // pass CI pointer to ASTConsumer</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">int main(int argc, const char **argv) &#123;</div><div class="line">    // parse the command-line args passed to your code</div><div class="line">    CommonOptionsParser op(argc, argv, StatSampleCategory);        </div><div class="line">    // create a new Clang Tool instance (a LibTooling environment)</div><div class="line">    ClangTool Tool(op.getCompilations(), op.getSourcePathList());</div><div class="line"></div><div class="line">    // run the Clang Tool, creating a new FrontendAction (explained below)</div><div class="line">    int result = Tool.run(newFrontendActionFactory&lt;ExampleFrontendAction&gt;().get());</div><div class="line"></div><div class="line">    errs() &lt;&lt; &quot;\nFound &quot; &lt;&lt; numFunctions &lt;&lt; &quot; functions.\n\n&quot;;</div><div class="line">    // print out the rewritten source code (&quot;rewriter&quot; is a global var.)</div><div class="line">    rewriter.getEditBuffer(rewriter.getSourceMgr().getMainFileID()).write(errs());</div><div class="line">    return result;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面的代码通过遍历语法树，去修改里面的方法名和返回变量名：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">before:</div><div class="line">void do_math(int *x) &#123;</div><div class="line">    *x += 5;</div><div class="line">&#125;</div><div class="line"></div><div class="line">int main(void) &#123;</div><div class="line">    int result = -1, val = 4;</div><div class="line">    do_math(&amp;val);</div><div class="line">    return result;</div><div class="line">&#125;</div><div class="line"></div><div class="line">after:</div><div class="line">** Rewrote function def: do_math</div><div class="line">** Rewrote function call</div><div class="line">** Rewrote ReturnStmt</div><div class="line"></div><div class="line">Found 2 functions.</div><div class="line"></div><div class="line">void add5(int *x) &#123;</div><div class="line">    *x += 5;</div><div class="line">&#125;</div><div class="line"></div><div class="line">int main(void) &#123;</div><div class="line">    int result = -1, val = 4;</div><div class="line">    add5(&amp;val);</div><div class="line">    return val;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>那么，我们看到<code>LibTooling</code>对代码的语法树有完全的控制，那么我们可以基于它去检查命名的规范，甚至做一个代码的转换，比如实现OC转Swift。</p>
<h3 id="4-3-ClangPlugin"><a href="#4-3-ClangPlugin" class="headerlink" title="4.3 ClangPlugin"></a>4.3 ClangPlugin</h3><p>对语法树有完全的控制权，作为插件注入到编译流程中，可以影响build和决定编译过程。目录:<code>llvm/tools/clang/examples</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div></pre></td><td class="code"><pre><div class="line">#include &quot;clang/Driver/Options.h&quot;</div><div class="line">#include &quot;clang/AST/AST.h&quot;</div><div class="line">#include &quot;clang/AST/ASTContext.h&quot;</div><div class="line">#include &quot;clang/AST/ASTConsumer.h&quot;</div><div class="line">#include &quot;clang/AST/RecursiveASTVisitor.h&quot;</div><div class="line">#include &quot;clang/Frontend/ASTConsumers.h&quot;</div><div class="line">#include &quot;clang/Frontend/FrontendActions.h&quot;</div><div class="line">#include &quot;clang/Frontend/CompilerInstance.h&quot;</div><div class="line">#include &quot;clang/Frontend/FrontendPluginRegistry.h&quot;</div><div class="line">#include &quot;clang/Rewrite/Core/Rewriter.h&quot;</div><div class="line"></div><div class="line">using namespace std;</div><div class="line">using namespace clang;</div><div class="line">using namespace llvm;</div><div class="line"></div><div class="line">Rewriter rewriter;</div><div class="line">int numFunctions = 0;</div><div class="line"></div><div class="line"></div><div class="line">class ExampleVisitor : public RecursiveASTVisitor&lt;ExampleVisitor&gt; &#123;</div><div class="line">private:</div><div class="line">    ASTContext *astContext; // used for getting additional AST info</div><div class="line"></div><div class="line">public:</div><div class="line">    explicit ExampleVisitor(CompilerInstance *CI) </div><div class="line">      : astContext(&amp;(CI-&gt;getASTContext())) // initialize private members</div><div class="line">    &#123;</div><div class="line">        rewriter.setSourceMgr(astContext-&gt;getSourceManager(), astContext-&gt;getLangOpts());</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    virtual bool VisitFunctionDecl(FunctionDecl *func) &#123;</div><div class="line">        numFunctions++;</div><div class="line">        string funcName = func-&gt;getNameInfo().getName().getAsString();</div><div class="line">        if (funcName == &quot;do_math&quot;) &#123;</div><div class="line">            rewriter.ReplaceText(func-&gt;getLocation(), funcName.length(), &quot;add5&quot;);</div><div class="line">            errs() &lt;&lt; &quot;** Rewrote function def: &quot; &lt;&lt; funcName &lt;&lt; &quot;\n&quot;;</div><div class="line">        &#125;    </div><div class="line">        return true;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    virtual bool VisitStmt(Stmt *st) &#123;</div><div class="line">        if (ReturnStmt *ret = dyn_cast&lt;ReturnStmt&gt;(st)) &#123;</div><div class="line">            rewriter.ReplaceText(ret-&gt;getRetValue()-&gt;getLocStart(), 6, &quot;val&quot;);</div><div class="line">            errs() &lt;&lt; &quot;** Rewrote ReturnStmt\n&quot;;</div><div class="line">        &#125;        </div><div class="line">        if (CallExpr *call = dyn_cast&lt;CallExpr&gt;(st)) &#123;</div><div class="line">            rewriter.ReplaceText(call-&gt;getLocStart(), 7, &quot;add5&quot;);</div><div class="line">            errs() &lt;&lt; &quot;** Rewrote function call\n&quot;;</div><div class="line">        &#125;</div><div class="line">        return true;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">class ExampleASTConsumer : public ASTConsumer &#123;</div><div class="line">private:</div><div class="line">    ExampleVisitor *visitor; // doesn&apos;t have to be private</div><div class="line"></div><div class="line">public:</div><div class="line">    // override the constructor in order to pass CI</div><div class="line">    explicit ExampleASTConsumer(CompilerInstance *CI):</div><div class="line">        visitor(new ExampleVisitor(CI)) &#123; &#125; // initialize the visitor</div><div class="line"></div><div class="line">    // override this to call our ExampleVisitor on the entire source file</div><div class="line">    virtual void HandleTranslationUnit(ASTContext &amp;Context) &#123;</div><div class="line">        /* we can use ASTContext to get the TranslationUnitDecl, which is</div><div class="line">             a single Decl that collectively represents the entire source file */</div><div class="line">        visitor-&gt;TraverseDecl(Context.getTranslationUnitDecl());</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">class PluginExampleAction : public PluginASTAction &#123;</div><div class="line">protected:</div><div class="line">    // this gets called by Clang when it invokes our Plugin</div><div class="line">    // Note that unique pointer is used here.</div><div class="line">    std::unique_ptr&lt;ASTConsumer&gt; CreateASTConsumer(CompilerInstance &amp;CI, StringRef file) &#123;</div><div class="line">        return llvm::make_unique&lt;ExampleASTConsumer&gt;(&amp;CI);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // implement this function if you want to parse custom cmd-line args</div><div class="line">    bool ParseArgs(const CompilerInstance &amp;CI, const vector&lt;string&gt; &amp;args) &#123;</div><div class="line">        return true;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"></div><div class="line">static FrontendPluginRegistry::Add&lt;PluginExampleAction&gt; X(&quot;-example-plugin&quot;, &quot;simple Plugin example&quot;);</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">clang -Xclang -load -Xclang ../build/lib/PluginExample.dylib -Xclang -plugin -Xclang -example-plugin -c testPlugin.c</div><div class="line"></div><div class="line">** Rewrote function def: do_math</div><div class="line">** Rewrote function call</div><div class="line">** Rewrote ReturnStmt</div></pre></td></tr></table></figure>
<p>我们可以基于ClangPlugin做些什么事情呢？我们可以用来定义一些编码规范，比如代码风格检查，命名检查等等。下面是我写的判断类名前两个字母是不是大写的例子，如果不是报错。(当然这只是一个例子而已。。。)</p>
<p><img src="http://7xtdl4.com1.z0.glb.clouddn.com/script_1482318703701.png" alt="image"></p>
<h2 id="五、动手写Pass"><a href="#五、动手写Pass" class="headerlink" title="五、动手写Pass"></a>五、动手写Pass</h2><h3 id="5-1-一个简单的Pass"><a href="#5-1-一个简单的Pass" class="headerlink" title="5.1 一个简单的Pass"></a>5.1 一个简单的Pass</h3><p>前面我们说到，Pass就是LLVM系统转化和优化的工作的一个节点，当然我们也可以写一个这样的节点去做一些自己的优化工作或者其它的操作。下面我们来看一下一个简单Pass的编写流程：</p>
<p>1.创建头文件  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">cd llvm/include/llvm/Transforms/</div><div class="line">mkdir Obfuscation</div><div class="line">cd Obfuscation</div><div class="line">touch SimplePass.h</div></pre></td></tr></table></figure>
<p>写入内容：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">#include &quot;llvm/IR/Function.h&quot;</div><div class="line">#include &quot;llvm/Pass.h&quot;</div><div class="line">#include &quot;llvm/Support/raw_ostream.h&quot;</div><div class="line">#include &quot;llvm/IR/Intrinsics.h&quot;</div><div class="line">#include &quot;llvm/IR/Instructions.h&quot;</div><div class="line">#include &quot;llvm/IR/LegacyPassManager.h&quot;</div><div class="line">#include &quot;llvm/Transforms/IPO/PassManagerBuilder.h&quot;</div><div class="line"></div><div class="line">// Namespace</div><div class="line">using namespace std;</div><div class="line"></div><div class="line">namespace llvm &#123;</div><div class="line">	Pass *createSimplePass(bool flag);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>2.创建源文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">cd llvm/lib/Transforms/</div><div class="line">mkdir Obfuscation</div><div class="line">cd Obfuscation</div><div class="line"></div><div class="line">touch CMakeLists.txt</div><div class="line">touch LLVMBuild.txt</div><div class="line">touch SimplePass.cpp</div></pre></td></tr></table></figure>
<p>CMakeLists.txt:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">add_llvm_library(LLVMObfuscation</div><div class="line">  SimplePass.cpp</div><div class="line">  </div><div class="line">  )</div><div class="line"></div><div class="line">  add_dependencies(LLVMObfuscation intrinsics_gen)</div></pre></td></tr></table></figure>
<p>LLVMBuild.txt:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[component_0]</div><div class="line">type = Library</div><div class="line">name = Obfuscation</div><div class="line">parent = Transforms</div><div class="line">library_name = Obfuscation</div></pre></td></tr></table></figure>
<p>SimplePass.cpp:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line">#include &quot;llvm/Transforms/Obfuscation/SimplePass.h&quot;</div><div class="line"></div><div class="line">using namespace llvm;</div><div class="line"></div><div class="line">namespace &#123;</div><div class="line">    struct SimplePass : public FunctionPass &#123;</div><div class="line">        static char ID; // Pass identification, replacement for typeid</div><div class="line">        bool flag;</div><div class="line">         </div><div class="line">        SimplePass() : FunctionPass(ID) &#123;&#125;</div><div class="line">        SimplePass(bool flag) : FunctionPass(ID) &#123;</div><div class="line">        	this-&gt;flag = flag;</div><div class="line">        &#125;</div><div class="line">         </div><div class="line">        bool runOnFunction(Function &amp;F) override &#123;</div><div class="line">        	if(this-&gt;flag)&#123;</div><div class="line">                Function *tmp = &amp;F;</div><div class="line">                // 遍历函数中的所有基本块</div><div class="line">                for (Function::iterator bb = tmp-&gt;begin(); bb != tmp-&gt;end(); ++bb) &#123;</div><div class="line">                    // 遍历基本块中的每条指令</div><div class="line">                    for (BasicBlock::iterator inst = bb-&gt;begin(); inst != bb-&gt;end(); ++inst) &#123;</div><div class="line">                        // 是否是add指令</div><div class="line">                        if (inst-&gt;isBinaryOp()) &#123;</div><div class="line">                            if (inst-&gt;getOpcode() == Instruction::Add) &#123;</div><div class="line">                                ob_add(cast&lt;BinaryOperator&gt;(inst));</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            return false;</div><div class="line">        &#125;</div><div class="line">         </div><div class="line">        // a+b === a-(-b)</div><div class="line">        void ob_add(BinaryOperator *bo) &#123;</div><div class="line">            BinaryOperator *op = NULL;</div><div class="line">             </div><div class="line">            if (bo-&gt;getOpcode() == Instruction::Add) &#123;</div><div class="line">                // 生成 (－b)</div><div class="line">                op = BinaryOperator::CreateNeg(bo-&gt;getOperand(1), &quot;&quot;, bo);</div><div class="line">                // 生成 a-(-b)</div><div class="line">                op = BinaryOperator::Create(Instruction::Sub, bo-&gt;getOperand(0), op, &quot;&quot;, bo);</div><div class="line">                 </div><div class="line">                op-&gt;setHasNoSignedWrap(bo-&gt;hasNoSignedWrap());</div><div class="line">                op-&gt;setHasNoUnsignedWrap(bo-&gt;hasNoUnsignedWrap());</div><div class="line">            &#125;</div><div class="line">             </div><div class="line">            // 替换所有出现该指令的地方</div><div class="line">            bo-&gt;replaceAllUsesWith(op);</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">&#125;</div><div class="line"> </div><div class="line">char SimplePass::ID = 0;</div><div class="line"> </div><div class="line">// 注册pass 命令行选项显示为simplepass</div><div class="line">static RegisterPass&lt;SimplePass&gt; X(&quot;simplepass&quot;, &quot;this is a Simple Pass&quot;);</div><div class="line">Pass *llvm::createSimplePass() &#123; return new SimplePass(); &#125;</div></pre></td></tr></table></figure>
<p>修改<code>.../Transforms/LLVMBuild.txt</code>, 加上刚刚写的模块<code>Obfuscation</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">subdirectories = Coroutines IPO InstCombine Instrumentation Scalar Utils Vectorize ObjCARC Obfuscation</div></pre></td></tr></table></figure>
<p>修改<code>.../Transforms/CMakeLists.txt</code>,  加上刚刚写的模块<code>Obfuscation</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">add_subdirectory(Obfuscation)</div></pre></td></tr></table></figure>
<p>编译生成：<code>LLVMSimplePass.dylib</code></p>
<p>因为Pass是作用于中间代码，所以我们首先要生成一份中间代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">clang -emit-llvm -c test.c -o test.bc</div></pre></td></tr></table></figure>
<p>然后加载Pass优化：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">../build/bin/opt -load ../build/lib/LLVMSimplePass.dylib -test &lt; test.bc &gt; after_test.bc</div></pre></td></tr></table></figure>
<p>对比中间代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">llvm-dis test.bc -o test.ll</div><div class="line">llvm-dis after_test.bc -o after_test.ll</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">test.ll</div><div class="line">......</div><div class="line">entry:</div><div class="line">  %retval = alloca i32, align 4</div><div class="line">  %a = alloca i32, align 4</div><div class="line">  %b = alloca i32, align 4</div><div class="line">  %c = alloca i32, align 4</div><div class="line">  store i32 0, i32* %retval, align 4</div><div class="line">  store i32 3, i32* %a, align 4</div><div class="line">  store i32 4, i32* %b, align 4</div><div class="line">  %0 = load i32, i32* %a, align 4</div><div class="line">  %1 = load i32, i32* %b, align 4</div><div class="line">  %add = add nsw i32 %0, %1</div><div class="line">  store i32 %add, i32* %c, align 4</div><div class="line">  %2 = load i32, i32* %c, align 4</div><div class="line">  %call = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([4 x i8], [4 x i8]* @.str, i32 0, i32 0), i32 %2)</div><div class="line">  ret i32 0</div><div class="line">&#125;</div><div class="line">......</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">after_test.ll</div><div class="line">......</div><div class="line">entry:</div><div class="line">  %retval = alloca i32, align 4</div><div class="line">  %a = alloca i32, align 4</div><div class="line">  %b = alloca i32, align 4</div><div class="line">  %c = alloca i32, align 4</div><div class="line">  store i32 0, i32* %retval, align 4</div><div class="line">  store i32 3, i32* %a, align 4</div><div class="line">  store i32 4, i32* %b, align 4</div><div class="line">  %0 = load i32, i32* %a, align 4</div><div class="line">  %1 = load i32, i32* %b, align 4</div><div class="line">  %2 = sub i32 0, %1</div><div class="line">  %3 = sub nsw i32 %0, %2</div><div class="line">  %add = add nsw i32 %0, %1</div><div class="line">  store i32 %3, i32* %c, align 4</div><div class="line">  %4 = load i32, i32* %c, align 4</div><div class="line">  %call = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([4 x i8], [4 x i8]* @.str, i32 0, i32 0), i32 %4)</div><div class="line">  ret i32 0</div><div class="line">&#125;</div><div class="line">......</div></pre></td></tr></table></figure>
<p>这里写的Pass只是把a+b简单的替换成了a-(-b),只是一个演示，怎么去写自己的Pass，并且作用于代码。</p>
<h3 id="5-2-将Pass加入PassManager管理"><a href="#5-2-将Pass加入PassManager管理" class="headerlink" title="5.2 将Pass加入PassManager管理"></a>5.2 将Pass加入PassManager管理</h3><p>上面我们是单独去加载Pass动态库，这里我们将Pass加入PassManager，这样我们就可以直接通过clang的参数去加载我们的Pass了。</p>
<p>首先在<code>llvm/lib/Transforms/IPO/PassManagerBuilder.cpp</code>添加头文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">#include &quot;llvm/Transforms/Obfuscation/SimplePass.h&quot;</div></pre></td></tr></table></figure>
<p>然后添加如下语句：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">static cl::opt&lt;bool&gt; SimplePass(&quot;simplepass&quot;, cl::init(false),</div><div class="line">                           cl::desc(&quot;Enable simple pass&quot;));</div></pre></td></tr></table></figure>
<p>然后在<code>populateModulePassManager</code>这个函数中添加如下代码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">MPM.add(createSimplePass(SimplePass));</div></pre></td></tr></table></figure>
<p>最后在IPO这个目录的<code>LLVMBuild.txt</code>中添加库的支持，否则在编译的时候会提示链接错误。具体内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">required_libraries = Analysis Core InstCombine IRReader Linker Object ProfileData Scalar Support TransformUtils Vectorize Obfuscation</div></pre></td></tr></table></figure>
<p>最后再编译一次。</p>
<p>那么我们可以这么去调用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">../build/bin/clang -mllvm -simplepass test.c -o after_test</div></pre></td></tr></table></figure>
<p>基于Pass，我们可以做什么？ 我们可以编写自己的Pass去混淆代码，以增加他人反编译的难度。</p>
<center><img src="http://7xtdl4.com1.z0.glb.clouddn.com/script_1482320959711.png"></center>

<p>我们可以把代码左上角的样子，变成右下角的样子，甚至更加复杂~ </p>
<h2 id="六、总结"><a href="#六、总结" class="headerlink" title="六、总结"></a>六、总结</h2><p>上面说了那么说，来总结一下：</p>
<p>1.LLVM编译一个源文件的过程：</p>
<p>预处理 -&gt; 词法分析 -&gt; Token -&gt; 语法分析 -&gt; AST -&gt; 代码生成 -&gt; LLVM IR -&gt; 优化 -&gt; 生成汇编代码 -&gt; Link -&gt; 目标文件</p>
<p>2.基于LLVM，我们可以做什么？</p>
<ol>
<li>做语法树分析，实现语言转换OC转Swift、JS or 其它语言，字符串加密。</li>
<li>编写ClangPlugin，命名规范，代码规范，扩展功能。</li>
<li>编写Pass，代码混淆优化。</li>
</ol>
<p>这篇只是一个简单的入门介绍，个人还需要深入去学习LLVM，再给大家分享，如有问题，欢迎拍砖~  </p>

      
    </div>

    <div>
      
        
<div id="wechat_subscriber" style="display: block； padding: 10px 0; margin: 20px auto; width: 100%; text-align: center">
    <img id="wechat_subscriber_qcode" src="/images/wx-qrcode.jpg" alt="AloneMonkey wechat" style="width: 200px; max-width: 100%;"/>
    <div>欢迎您扫一扫上面的微信公众号，订阅我的博客！</div>
</div>

      
    </div>

    <div>
      
        
<style type="text/css">
.donate_bar {
  text-align: center;
  margin-top: 5%
}

.donate_bar a.btn_donate {
  display: inline-block;
  width: 82px;
  height: 82px;
  margin-left: auto;
  margin-right: auto;
  background: url(http://img.t.sinajs.cn/t5/style/images/apps_PRF/e_media/btn_reward.gif)no-repeat;
  -webkit-transition: background 0s;
  -moz-transition: background 0s;
  -o-transition: background 0s;
  -ms-transition: background 0s;
  transition: background 0s
}

.donate_bar a.btn_donate:hover {
  background-position: 0 -82px
}

.donate_bar .donate_txt {
  display: block;
  color: #9d9d9d;
  font: 14px/2 "Microsoft Yahei"
}
.donate_bar.hidden{
  display: none
}

.post-donate{
  margin-top: 80px;
}

#donate_guide{
  height: 210px;
  width: 420px;
  margin: 0 auto;
}

#donate_guide img{
  height: 200px;
  height: 200px;
  display:inline;
  margin:auto 2px;
}
</style>
<! -- 添加捐赠图标 -->
<div class ="post-donate">
    <div id="donate_board" class="donate_bar center">
        <a id="btn_donate" class="btn_donate" href="javascript:;" title="打赏"></a>
        <span class="donate_txt">
           &uarr;<br>
           感谢你的支持，我会继续努力！
        </span>
        <br>
      </div>  
  <div id="donate_guide" class="donate_bar center hidden" >
    <!-- 支付宝打赏图案 -->
    <img src="/images/alipay.jpg" alt="支付宝打赏"> 
    <!-- 微信打赏图案 -->
    <img src="/images/wxpay.jpg" alt="微信打赏">  
    </div>
  <script type="text/javascript">
    document.getElementById('btn_donate').onclick = function(){
      $('#donate_board').addClass('hidden');
      $('#donate_guide').removeClass('hidden');
    }
  </script>
</div>
<! -- 添加捐赠图标 -->


      
    </div>

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/LLVM/" rel="tag">#LLVM</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/12/21/weekly/" rel="next" title="第十期 Coder群周报">
                <i class="fa fa-chevron-left"></i> 第十期 Coder群周报
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/12/22/weekly/" rel="prev" title="第十一期 Coder群周报">
                第十一期 Coder群周报 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
        <div class="ds-share flat" data-thread-key="2016/12/21/learning-llvm/"
     data-title="关于LLVM，这些东西你必须知道！"
     data-content=""
     data-url="http://www.alonemonkey.com/2016/12/21/learning-llvm/">
  <div class="ds-share-inline">
    <ul  class="ds-share-icons-16">

      <li data-toggle="ds-share-icons-more"><a class="ds-more" href="javascript:void(0);">分享到：</a></li>
      <li><a class="ds-weibo" href="javascript:void(0);" data-service="weibo">微博</a></li>
      <li><a class="ds-qzone" href="javascript:void(0);" data-service="qzone">QQ空间</a></li>
      <li><a class="ds-qqt" href="javascript:void(0);" data-service="qqt">腾讯微博</a></li>
      <li><a class="ds-wechat" href="javascript:void(0);" data-service="wechat">微信</a></li>

    </ul>
    <div class="ds-share-icons-more">
    </div>
  </div>
</div>
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2016/12/21/learning-llvm/"
           data-title="关于LLVM，这些东西你必须知道！" data-url="http://www.alonemonkey.com/2016/12/21/learning-llvm/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="AloneMonkey" />
          <p class="site-author-name" itemprop="name">AloneMonkey</p>
          <p class="site-description motion-element" itemprop="description">猿，改变世界的动物！</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">21</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">9</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">10</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/xiaoqing28" target="_blank" title="微博">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  微博
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.zhihu.com/people/AloneMonkey" target="_blank" title="知乎">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  知乎
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="https://github.com/AloneMonkey" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        

        
        
          <div class="links-of-blogroll motion-element links-of-blogroll-inline">
            <div class="links-of-blogroll-title">
              <i class="fa  fa-fw fa-globe"></i>
              Links
            </div>
            <ul class="links-of-blogroll-list">
              
                <li class="links-of-blogroll-item">
                  <a href="http://www.blogfshare.com/" title="Coder" target="_blank">Coder</a>
                </li>
              
            </ul>
          </div>
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#一、什么是LLVM？"><span class="nav-number">1.</span> <span class="nav-text">一、什么是LLVM？</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二、安装编译LLVM"><span class="nav-number">2.</span> <span class="nav-text">二、安装编译LLVM</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#三、从源码到可执行文件"><span class="nav-number">3.</span> <span class="nav-text">三、从源码到可执行文件</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-预处理（Preprocess）"><span class="nav-number">3.1.</span> <span class="nav-text">3.1 预处理（Preprocess）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-词法分析-Lexical-Analysis"><span class="nav-number">3.2.</span> <span class="nav-text">3.2 词法分析 (Lexical Analysis)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-语法分析-Semantic-Analysis"><span class="nav-number">3.3.</span> <span class="nav-text">3.3 语法分析 (Semantic Analysis)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-IR代码生成-CodeGen"><span class="nav-number">3.4.</span> <span class="nav-text">3.4 IR代码生成 (CodeGen)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-5-生成字节码-LLVM-Bitcode"><span class="nav-number">3.5.</span> <span class="nav-text">3.5 生成字节码 (LLVM Bitcode)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-6-生成相关汇编"><span class="nav-number">3.6.</span> <span class="nav-text">3.6 生成相关汇编</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-7-生成目标文件"><span class="nav-number">3.7.</span> <span class="nav-text">3.7 生成目标文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-8-生成可执行文件"><span class="nav-number">3.8.</span> <span class="nav-text">3.8 生成可执行文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-9-整体流程"><span class="nav-number">3.9.</span> <span class="nav-text">3.9 整体流程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#四、可以用Clang做什么？"><span class="nav-number">4.</span> <span class="nav-text">四、可以用Clang做什么？</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-libclang进行语法分析"><span class="nav-number">4.1.</span> <span class="nav-text">4.1 libclang进行语法分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-LibTooling"><span class="nav-number">4.2.</span> <span class="nav-text">4.2 LibTooling</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-ClangPlugin"><span class="nav-number">4.3.</span> <span class="nav-text">4.3 ClangPlugin</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#五、动手写Pass"><span class="nav-number">5.</span> <span class="nav-text">五、动手写Pass</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#5-1-一个简单的Pass"><span class="nav-number">5.1.</span> <span class="nav-text">5.1 一个简单的Pass</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5-2-将Pass加入PassManager管理"><span class="nav-number">5.2.</span> <span class="nav-text">5.2 将Pass加入PassManager管理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#六、总结"><span class="nav-number">6.</span> <span class="nav-text">六、总结</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">AloneMonkey</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="http://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="//cdn.bootcss.com/jquery/2.1.3/jquery.min.js"></script>

  
  <script type="text/javascript" src="//cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js"></script>

  
  <script type="text/javascript" src="//cdn.bootcss.com/jquery.lazyload/1.9.1/jquery.lazyload.min.js"></script>

  
  <script type="text/javascript" src="//cdn.bootcss.com/velocity/1.2.3/velocity.min.js"></script>

  
  <script type="text/javascript" src="//cdn.bootcss.com/velocity/1.2.3/velocity.ui.min.js"></script>

  
  <script type="text/javascript" src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"alonemonkey"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
  





  
  
  

  

  
<script type="text/javascript" async src="//push.zhanzhang.baidu.com/push.js">
</script>


</body>
</html>
